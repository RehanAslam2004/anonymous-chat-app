<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Anonymous Chat</title>
    <link rel="stylesheet" href="/static/style.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.5.4/socket.io.js"></script>
    <script>
        // Theme initialization before the UI loads
        (function(){
            try{
                const t = localStorage.getItem('theme') || 'dark';
                document.documentElement.setAttribute('data-theme', t);
            }catch(e){}
        })();
    </script>
</head>
<body>

<main class="app">
    <header class="app-header">
        <div class="brand">Anonymous Chat</div>
        <div class="header-controls">
            <span id="connection-status" style="font-size:12px;color:var(--muted);margin-right:12px">‚óè</span>
            <button id="theme-toggle" aria-label="Toggle theme">üåô</button>
        </div>
    </header>

    <section id="join-screen" class="panel center">
        <div class="panel-card">
            <h2>Join a Chat Room</h2>
            <input id="room" placeholder="Room ID" autocomplete="off">
            <div style="margin-top:8px;font-size:11px;color:var(--muted)">
                Status: <span id="status-text">Connecting...</span>
            </div>
            <div class="actions">
                <button id="join-btn" type="button">Join</button>
            </div>
        </div>
    </section>

    <section id="chat-screen" class="panel" style="display:none;">
        <div class="chat-layout">
            <div class="chat-info">
                <h3 id="room-title"></h3>
                <p style="margin:6px 0;font-size:12px;color:var(--muted)">You are: <span id="user-handle" style="font-weight:600;color:var(--accent)"></span></p>
            </div>

            <div id="messages" class="messages" role="log" aria-live="polite"></div>

            <form id="composer" class="composer" onsubmit="return false;">
                <input id="msg" placeholder="Type message..." autocomplete="off">
                <button id="send-btn" type="button">Send</button>
            </form>
        </div>
    </section>

</main>

<script>
const socket = io();
let handle = "";
let roomID = "";
let pendingJoin = null;

// Update connection status text
function updateConnectionStatus() {
    const status = document.getElementById('status-text');
    if(socket.connected) {
        status.textContent = 'Connected ‚úì';
        status.style.color = 'var(--accent)';
    } else {
        status.textContent = 'Disconnected';
        status.style.color = 'var(--muted)';
    }
}

// Theme toggle
const themeToggle = document.getElementById('theme-toggle');
function updateThemeButton() {
    const t = document.documentElement.getAttribute('data-theme') || 'dark';
    themeToggle.textContent = t === 'dark' ? 'üåô' : '‚òÄÔ∏è';
}
themeToggle && themeToggle.addEventListener('click', () => {
    const cur = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
    const next = cur === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    try{ localStorage.setItem('theme', next); }catch(e){}
    updateThemeButton();
});
updateThemeButton();

// Join flow
document.getElementById('join-btn').addEventListener('click', joinRoom);
document.getElementById('room').addEventListener('keydown', (e)=>{ if(e.key === 'Enter') joinRoom(); });

// Disable send until we have a handle (joined)
document.getElementById('send-btn').disabled = true;

function joinRoom(){
    const roomInput = document.getElementById('room').value.trim();
    if(!roomInput) {
        alert('Please enter a room ID');
        return;
    }
    
    if(!socket.connected) {
        // queue join for when socket connects
        pendingJoin = roomInput;
        document.getElementById('status-text').textContent = 'Queued join ‚Äî waiting for connection...';
        console.log('Join queued, socket not connected yet');
        return;
    }

    roomID = roomInput;
    console.log('Joining room:', roomID);
    document.getElementById('join-screen').style.display = 'none';
    document.getElementById('chat-screen').style.display = 'block';
    document.getElementById('room-title').innerText = 'Room: ' + roomID;
    socket.emit('join', {room: roomID});
}

socket.on('your_handle', (h)=>{ 
    handle = h; 
    document.getElementById('user-handle').textContent = h;
    console.log('Received handle:', h);
    // enable sending once we have an assigned handle
    const sendBtn = document.getElementById('send-btn');
    if(sendBtn) sendBtn.disabled = false;
});

socket.on('message_history', (data)=> {
    console.log('Message history received:', data);
    // Load message history from database (in chronological order)
    if(data.messages && Array.isArray(data.messages)) {
        data.messages.forEach((msg) => {
            const isMe = msg.user_handle === handle;
            addMessage(msg.user_handle + ': ' + msg.message_text, isMe ? 'msg me' : 'msg');
        });
    }
});

socket.on('system', (msg)=> {
    console.log('System message:', msg);
    addMessage('üîî ' + msg, 'system');
});

socket.on('message', (data)=> {
    console.log('Message received:', data);
    const isMe = data.handle === handle;
    addMessage(data.handle + ': ' + data.text, isMe ? 'msg me' : 'msg');
});

// Composer
document.getElementById('send-btn').addEventListener('click', sendMsg);
document.getElementById('msg').addEventListener('keydown', (e)=>{ if(e.key === 'Enter') sendMsg(); });

function sendMsg(){
    const input = document.getElementById('msg');
    const text = input.value.trim();
    if(!text) return;
    console.log('Sending message:', {room: roomID, handle: handle, text: text});
    socket.emit('message', {room: roomID, handle: handle, text: text});
    input.value = '';
}

function addMessage(text, kind='msg'){
    const box = document.getElementById('messages');
    const el = document.createElement('div');
    el.className = 'message ' + kind;
    el.textContent = text;
    box.appendChild(el);
    box.scrollTop = box.scrollHeight;
}

// Socket.IO event monitoring
socket.on('connect', ()=>{ 
    console.log('Connected to server');
    document.getElementById('connection-status').textContent = 'üü¢';
    document.getElementById('connection-status').title = 'Connected';
    updateConnectionStatus();
    // If a join was queued while disconnected, emit it now
    if(pendingJoin) {
        console.log('Emitting queued join for room', pendingJoin);
        roomID = pendingJoin;
        pendingJoin = null;
        document.getElementById('join-screen').style.display = 'none';
        document.getElementById('chat-screen').style.display = 'block';
        document.getElementById('room-title').innerText = 'Room: ' + roomID;
        socket.emit('join', {room: roomID});
    }
});

socket.on('disconnect', ()=>{ 
    console.log('Disconnected from server');
    document.getElementById('connection-status').textContent = 'üî¥';
    document.getElementById('connection-status').title = 'Disconnected';
    updateConnectionStatus();
});

socket.on('connect_error', (err)=>{ 
    console.error('Connection error:', err);
    document.getElementById('connection-status').textContent = 'üü°';
    document.getElementById('connection-status').title = 'Connection error: ' + err;
});

// Initial status check
document.addEventListener('DOMContentLoaded', updateConnectionStatus);
setTimeout(updateConnectionStatus, 500);

</script>

</body>
</html>
